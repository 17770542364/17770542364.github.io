---
title: 直播平台技术原理
date: 2022-07-05 19:38:29
top: true
categories: 音视频
tags:
- 音视频
---

# 直播平台技术原理

## 直播相关基础知识

### 图片原始采样数据--RGB

RGB格式：每一个数据单元表示RGB三原色，用各原色其所占位数来表示

RGB888(24位色)

RGB565(16位色)

为什么RGB565要多留一位给绿色G？

人眼大约有1.2亿个视杆细胞和600万个视锥细胞。视杆细胞感知光度，视锥细胞有三种，分别对不同波长的光敏感（蓝绿红）。

视杆细胞对绿色波段最为敏感。人眼对光度的敏感度远大于颜色。

![image-20211024193326848](直播平台技术原理/image-20211024193326848.png)

### 亮度、色度模型数据--YUV

YUV颜色空间是从RGB颜色空间推导而来。

![image-20211024193427601](直播平台技术原理/image-20211024193427601.png)

YUV3种采样模式：444，422，420。数字表示Y、U、V三个分量的采样比。

![image-20211024193529635](直播平台技术原理/image-20211024193529635.png)

YUV420比RGB888节约四分之三的空间

### 为什么需要视频编解码？

不考虑音频的情况下，一段1小时1080P的纯视频未编码原始数据(RGB888)大小为500G.

### 如何进行编码？

视频冗余信息

![image-20211024194005467](直播平台技术原理/image-20211024194005467.png)

冗余信息分析--分组、分块

### 视频帧的类型

![image-20211024194824732](直播平台技术原理/image-20211024194824732.png)

B帧不适合用于直播场景。因为没有下一帧信息。

### 帧的编码方式

![image-20211024195154446](直播平台技术原理/image-20211024195154446.png)

对I帧的处理，是采用**帧内编码方式**，只利用本帧图像内的空间相关性。

![image-20211024195347314](直播平台技术原理/image-20211024195347314.png)

对P帧的处理，采用**帧间编码**（运动估计和补偿），同时利用空间和时间上的相关性。

![image-20211024195446313](直播平台技术原理/image-20211024195446313.png)

### 量化

通过用更粗糙的数据表示精细的数据来降低编码的数据量，或者通过去除人眼不敏感的信息来降低编码数据量。

![image-20211024195857629](直播平台技术原理/image-20211024195857629.png)

### 编码过程

1.每一帧原始采样分块

2.图片分组

​	有差别的像素只有10%以内的点，亮度差值变化不超过2%，而色度差值变化只有1%以内

​	一组称为一个GOP（包括一份I帧和多份P/B帧）

3.逐帧编码

![image-20211024200233108](直播平台技术原理/image-20211024200233108.png)

### 封装格式

![image-20211024200824876](直播平台技术原理/image-20211024200824876.png)

### 网络传输协议

![image-20211024201249972](直播平台技术原理/image-20211024201249972.png)

### 整体回顾

![image-20211024201648477](直播平台技术原理/image-20211024201648477.png)

## 如何搭建一套直播系统

### 基础直播系统结构

![image-20211024202202871](直播平台技术原理/image-20211024202202871.png)

### 客户端推流处理过程

![image-20211024202246829](直播平台技术原理/image-20211024202246829.png)

![image-20211024202258180](直播平台技术原理/image-20211024202258180.png)

软编码：使用CPU进行编码，通过软件代码来实现音视频编解码算法，如FFMpeg,GPUImage等。

硬编码：使用非CPU的硬件芯片或电路实现编码算法，通过调用编解码芯片提供的API来实现，如安卓的MediaCodec等。

现在的智能手机的“芯片”从严格意义上说其实已经不是单纯一个CPU，而是SoC，由CPU，GPU，DSP等芯片集成在一起。

### RTMP协议推流过程--握手

![image-20211024203037221](直播平台技术原理/image-20211024203037221.png)

![image-20211024203043508](直播平台技术原理/image-20211024203043508.png)

### RTMP协议推流过程--推流

![image-20211024203241492](直播平台技术原理/image-20211024203241492.png)

### RTMP协议报文格式

RTMP协议中一块有完整意义的单位是“消息”，但一段“消息”在网上传输时被拆分成“消息块(Chunk)”，每块一般固定128字节(不含分块头)，最后一块(同一段报文的)可以小于128字节。

![image-20211024203539974](直播平台技术原理/image-20211024203539974.png)

![image-20211024203549408](直播平台技术原理/image-20211024203549408.png)

### 服务端处理过程

基础流媒体服务器主要包含几个功能：信令处理；视频流处理(转码、转封装、接&拉流)；视频文件存储

流媒体服务器有大量成熟解决方案（开源、商业化）：如 SRS\NGINX\CRTMPD\AMS\WOWZA等

![image-20211024204519607](直播平台技术原理/image-20211024204519607.png)

###  整体开源解决方案

基于OBS （PC强大的采集工具）+ SRS（开源流媒体服务器）可以快速搭建一套直播模型。

![image-20211024205130563](直播平台技术原理/image-20211024205130563.png)

## 从原型到千万DAU的直播平台

### 直播平台基础架构图

![image-20211024205352095](直播平台技术原理/image-20211024205352095.png)

### 流媒体服务器集群

![image-20211024205542614](直播平台技术原理/image-20211024205542614.png)

### 业务服务框架-TAF

![image-20211024205916508](直播平台技术原理/image-20211024205916508.png)

IDL:接口定义语言JCE

RPC:同步、异步、单向

高性能：负载均衡算法、过载保护、熔断等

可伸缩：支持水平扩容

服务治理：部署、发布、扩/缩容、测试、配置中心、监控等

### 其他需要具备的能力

日志处理

![image-20211024210436277](直播平台技术原理/image-20211024210436277.png)

链接通道

![image-20211024210452900](直播平台技术原理/image-20211024210452900.png)
